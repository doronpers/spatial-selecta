# Environment Variables Verification Checklist

## Required Environment Variables

Based on your `render.yaml` configuration, here are the environment variables that need to be set:

### ‚úÖ Auto-Configured (via render.yaml)
- `ENVIRONMENT` = `production` ‚úÖ (set in render.yaml)
- `DATABASE_URL` ‚úÖ (auto-set from database connection)
- `SCAN_INTERVAL_HOURS` = `48` ‚úÖ (set in render.yaml)
- `REFRESH_API_TOKEN` ‚úÖ (will be auto-generated by Render)

### ‚ö†Ô∏è Must Set Manually in Render Dashboard

These are marked as `sync: false` in render.yaml, meaning you need to set them manually:

1. **`APPLE_MUSIC_DEVELOPER_TOKEN`** ‚ö†Ô∏è **REQUIRED**
   - You mentioned you have this token
   - Set in: Render Dashboard ‚Üí Your Web Service ‚Üí Environment tab
   - Format: `eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6...` (JWT token)

2. **`ALLOWED_ORIGINS`** ‚ö†Ô∏è **REQUIRED**
   - Set in: Render Dashboard ‚Üí Your Web Service ‚Üí Environment tab
   - Format: Comma-separated list of frontend URLs
   - Examples:
     - If using Render subdomain: `https://spatial-selecta-frontend.onrender.com`
     - If using custom domain: `https://yourdomain.com,https://www.yourdomain.com`
     - **NO wildcards** (`*`) allowed in production

### Optional Environment Variables

- `APPLE_MUSIC_USER_TOKEN` (optional, for user-specific data)
- `APPLE_TEAM_ID`, `APPLE_KEY_ID`, `APPLE_KEY_PATH` (only needed if generating tokens dynamically)

---

## Verification Steps

### Step 1: Check render.yaml Configuration

Your `render.yaml` looks good! ‚úÖ

**Backend Service:**
- ‚úÖ `ENVIRONMENT=production` is set
- ‚úÖ `DATABASE_URL` will be auto-connected
- ‚úÖ `REFRESH_API_TOKEN` will be auto-generated
- ‚ö†Ô∏è `ALLOWED_ORIGINS` needs manual setting (sync: false)
- ‚ö†Ô∏è `APPLE_MUSIC_DEVELOPER_TOKEN` needs manual setting (sync: false)

**Frontend Service:**
- ‚úÖ `API_URL` will be auto-set from backend service

**Database:**
- ‚úÖ PostgreSQL database will be created automatically

---

### Step 2: After Deploying to Render

1. **Go to Render Dashboard** ‚Üí Your Web Service (`spatial-selecta-api`)

2. **Navigate to Environment tab**

3. **Verify these variables exist:**
   - [ ] `ENVIRONMENT` = `production`
   - [ ] `DATABASE_URL` = `postgresql://...` (auto-set)
   - [ ] `REFRESH_API_TOKEN` = `...` (auto-generated)
   - [ ] `SCAN_INTERVAL_HOURS` = `48`

4. **Manually add these variables:**
   - [ ] `APPLE_MUSIC_DEVELOPER_TOKEN` = `<your-token>`
   - [ ] `ALLOWED_ORIGINS` = `<your-frontend-url>`

5. **Get your frontend URL:**
   - After deploying frontend, note the URL (e.g., `https://spatial-selecta-frontend.onrender.com`)
   - Use this in `ALLOWED_ORIGINS`

---

### Step 3: Test Configuration

After setting environment variables, test:

1. **Check Backend Health:**
   ```bash
   curl https://your-backend-url.onrender.com/api/health
   ```
   Should return: `{"status": "healthy", "timestamp": "..."}`

2. **Check Backend Logs:**
   - Go to Render Dashboard ‚Üí Your Web Service ‚Üí Logs
   - Look for:
     - ‚úÖ "Starting Spatial Selecta API..."
     - ‚úÖ "Application started successfully"
     - ‚úÖ "Background scheduler started - scanning every 48 hours"
     - ‚ö†Ô∏è If you see: "Apple Music Developer Token not configured" ‚Üí token not set
     - ‚ö†Ô∏è If you see: "SECURITY WARNING: CORS allows all origins" ‚Üí ALLOWED_ORIGINS not set

3. **Test API Endpoints:**
   ```bash
   # Get tracks (should work without auth)
   curl https://your-backend-url.onrender.com/api/tracks
   
   # Get stats
   curl https://your-backend-url.onrender.com/api/stats
   ```

4. **Test Frontend:**
   - Visit your frontend URL
   - Open browser console (F12)
   - Should see: "Loaded X tracks from API"
   - If you see CORS errors ‚Üí `ALLOWED_ORIGINS` is incorrect

---

## Common Issues & Solutions

### Issue: "Apple Music Developer Token not configured"
**Solution:** 
- Go to Render Dashboard ‚Üí Environment tab
- Add `APPLE_MUSIC_DEVELOPER_TOKEN` with your token value
- Redeploy or restart the service

### Issue: CORS errors in browser console
**Solution:**
- Check `ALLOWED_ORIGINS` includes your frontend URL exactly
- No trailing slashes: `https://yourdomain.com` not `https://yourdomain.com/`
- Include protocol: `https://` not just `yourdomain.com`
- Redeploy backend after changing

### Issue: "REFRESH_API_TOKEN not set in production"
**Solution:**
- This should auto-generate, but if not:
- Generate token: `python3 -c "import secrets; print(secrets.token_urlsafe(32))"`
- Add to Render Dashboard ‚Üí Environment tab

### Issue: Database connection errors
**Solution:**
- `DATABASE_URL` should auto-set from database
- Verify database service is running
- Check database name matches: `spatial_selecta`

---

## Quick Verification Script

After deployment, you can verify everything is set up correctly:

```bash
# 1. Check health
curl https://your-backend-url.onrender.com/api/health

# 2. Check stats (should return data)
curl https://your-backend-url.onrender.com/api/stats

# 3. Check tracks endpoint
curl https://your-backend-url.onrender.com/api/tracks?limit=5

# 4. Test manual refresh (requires REFRESH_API_TOKEN)
curl -X POST https://your-backend-url.onrender.com/api/refresh \
  -H "Authorization: Bearer YOUR_REFRESH_API_TOKEN"
```

---

## Next Steps After Environment Setup

1. ‚úÖ Verify all environment variables are set
2. ‚úÖ Check backend logs for any warnings
3. ‚úÖ Initialize database: Run `python3 backend/setup.py` via Render Shell
4. ‚úÖ Test frontend loads and displays data
5. ‚úÖ Verify scheduler starts (check logs)
6. üéâ Site is live!

---

**Last Updated**: 2025-01-27

